<html><head><meta charset="utf-8"></head><script src="pythons.js" type=module id="site" data-src="fs,vtx,gui" async defer>#<!--
import sys
import platform
import asyncio
from pathlib import Path



# screen pixels (real, hardware)
WIDTH=1024
HEIGHT=600

# reference/idealized screen pixels
REFX = 1980
REFY = 1080


def u(real, ref, v):
    if abs(v)<0.9999999:
        result = int( (float(real)/100.0) * (v*1000))
        if v<0:
            return real-result
        return result
    return int( (real/ref) * v )

def ux(*argv):
    global WIDTH, REFX
    acc = 0
    for v in argv:
        acc += u(WIDTH, REFX, v)
    return acc

def uy(*argv):
    global HEIGHT, REFY
    acc = 0
    for v in argv:
        acc += u(HEIGHT, REFY, v)
    return acc


import inspect
import sysconfig
import importlib
from aio.toplevel import AsyncInteractiveConsole


async def pv(track, prefix = '', suffix = '', decimals = 1, length = 100, fill = 'â–ˆ', printEnd = "\r"):

    # Progress Bar Printing Function
    def print_pg_bar(total, iteration):
        percent = ("{0:." + str(decimals) + "f}").format(100 * (iteration / float(total)))
        filledLength = int(length * iteration // total)
        bar = fill * filledLength + '-' * (length - filledLength)
        print(f'\r{prefix} |{bar}| {percent}% {suffix}', end = printEnd)

    # Update Progress Bar
    while True:
        print_pg_bar(track.len or 100, track.pos or 0)
        if track.avail:
            break
        await asyncio.sleep(.5)

    # Print New Line on Complete
    print()


async def get_repo_pkg(repo, pkg, resume , ex):
    print("-"*40)
    pkg_url = f"{repo['-CDN-']}{repo[pkg]}"
    print("getting", pkg_url )

    # get pkg

    pkg_file =  f"/tmp/{repo[pkg].rsplit('/',1)[-1]}"


    cfg = {
        "io": "url",
        "type":"fs",
        "path" : pkg_file
    }


    track = platform.window.MM.prepare(pkg_url, json.dumps(cfg))
    await pv(track)

    platlib = sysconfig.get_paths()["platlib"]
    if platlib not in sys.path:
        sys.path.append(platlib)
    try:
        aio.toplevel.install(pkg_file)
    except Exception as rx:
        pdb(f"failed to install {pkg_file}")
        sys.print_exception(rx)

    await asyncio.sleep(0)

    try:
        __EMSCRIPTEN__.explore(platlib)
        await asyncio.sleep(0)
        importlib.invalidate_caches()
        print(f"{pkg_file} installed")
    except Exception as rx:
        pdb(f"failed to preload {pkg_file}")
        sys.print_exception(rx)


    if resume and ex:
        try:
            if inspect.isawaitable(resume):
                print(f"{resume=} is an awaitable")
                return resume()
            else:
                print(f"{resume=} is not awaitable")
                resume()
                return asyncio.sleep(0)
        except Exception as resume_ex:
            sys.print_exception(ex, limit=-1)
        finally:
            print("-"*40)
    return None



def importer(want, ex=None, resume=None):
    global PyConfig
    for repo in PyConfig.pkg_repolist:
        if want in repo:
            return get_repo_pkg(repo, want, resume, ex)
        else:
            print(f"PKG NOT FOUND : {want=}, {resume=}, {ex=}")
    return asyncio.sleep(0)



if sys.platform in ("emscripten","wasi",):

    platform.window.python.is_ready = True

    log =  platform.console

    try:
        platform.document.body.style.background = "#7f7f7f"
        import pygame
        screen = pygame.display.set_mode([ux(.100),uy(.100)], pygame.SRCALPHA, 32)
        screen.set_colorkey( (0,0,0,0), pygame.RLEACCEL )
        screen.fill( (0,0,0,0) )

    except Exception as _:
        pygame = False
        sys.print_exception(_)
        log.error("cannot load pygame and clear canvas")




    async def sitecustomize():
        global PyConfig, con

        # reset term
        ESC("c")

        sys.argv = PyConfig.pop("argv", [])


        from types import SimpleNamespace


        #print(json.dumps(PyConfig, sort_keys=True, indent=4))


        PyConfig = SimpleNamespace(**PyConfig)
        PyConfig.pkg_index = ['https://pygame-web.github.io/archives/repo/']

        class VFS:
            from pathlib import Path
            script = Path(PyConfig.run_filename) # or sys.argv[0]
            if script.suffix.lower() == ".py":
                print("Loading:", script )

        PyConfig.pkg_repolist = []
        abitag = f"cp{sys.version_info.major}{sys.version_info.minor}"
        for repo in PyConfig.pkg_index:
            async with fopen(f'{repo}index.json', 'r') as index:
                try:
                    data = index.read().replace("<abi>",abitag)
                    repo = json.loads(data)
                except:
                    pdb(f"{repo}: malformed json index {data}")
                    continue
                PyConfig.pkg_repolist.append( repo )


        async_console = AsyncInteractiveConsole(
                globals(),
                shell=shell,
                importer=importer,
            ).interact()

        aio.create_task(async_console)


        if 1: #not pygame:
            return

        rng = 10 # resolution of progress bar
        slot = ux(.060)/rng # 60%

        async def compose(delay=0):
            global screen
            pygame.display.update()
            platform.window.chromakey(None, *screen.get_colorkey(), 40)
            await asyncio.sleep(delay)

        for i in range(rng):
            marginx = ux(.020) # 20%
            marginy = uy(.045) # 45%
            pygame.draw.rect(screen,(10,10,10),( marginx-ux(10), marginy-uy(10), (rng*slot)+ux(20), uy(110) ) )
            pygame.draw.rect(screen,(0,255,0), ( marginx, marginy, (1+i)*slot, uy(90)) )
            await compose(1)



    asyncio.run(sitecustomize())





# --></script></html>










